{% extends "base.html" %}

{% block title %}Dashboard - Marketing Insights{% endblock %}

{% block header %}Marketing Performance Dashboard{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="row">
        <!-- Funnel Overview Card -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Conversion Funnel</h5>
                </div>
                <div class="card-body">
                    <canvas id="funnelChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Conversion Rates Card -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Conversion Rates</h5>
                </div>
                <div class="card-body">
                    <canvas id="conversionChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Campaign Performance Card -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Campaign Performance</h5>
                </div>
                <div class="card-body">
                    <canvas id="campaignChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Channel Performance Card -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Channel Performance</h5>
                </div>
                <div class="card-body">
                    <canvas id="channelChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Acquisition Cost Table -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Customer Acquisition Cost</h5>
                    <div class="d-flex">
                        <div class="me-2">
                            <label for="perPageSelect" class="me-1">Show:</label>
                            <select id="perPageSelect" class="form-select form-select-sm">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <div>
                            <label for="sortSelect" class="me-1">Sort by:</label>
                            <select id="sortSelect" class="form-select form-select-sm">
                                <option value="channel">Channel</option>
                                <option value="roi">ROI</option>
                                <option value="conversion_rate">Conversion Rate</option>
                                <option value="acquisition_cost">Acquisition Cost</option>
                            </select>
                        </div>
                        <button id="sortDirectionBtn" class="btn btn-sm btn-outline-secondary ms-2">
                            <i class="fas fa-sort-amount-up"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="cacTable" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Channel</th>
                                    <th>ROI (%)</th>
                                    <th>Conversion Rate (%)</th>
                                    <th>Acquisition Cost ($)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="pagination" class="d-flex justify-content-between align-items-center mt-3">
                        <!-- Pagination will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- No data message -->
    <div id="noDataMessage" class="text-center my-5" style="display: none;">
        <div class="alert alert-info">
            <h4 class="alert-heading">No Data Available</h4>
            <p>There is no marketing data to display. Please upload a dataset.</p>
            {% if current_user.is_authenticated %}
                <a href="{{ url_for('main.upload') }}" class="btn btn-primary">Upload Data</a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global state to track pagination
    const state = {
        cacPage: 1,
        cacPerPage: 10,
        cacSortBy: 'roi',
        cacSortDir: 'desc'
    };
    
    // Chart instances to manage destruction/recreation
    let funnelChartInstance = null;
    let conversionChartInstance = null;
    let campaignChartInstance = null;
    let channelChartInstance = null;
    
    // Fetch dashboard data using the optimized endpoints
    document.addEventListener('DOMContentLoaded', function() {
        // Show loading indicators
        showLoading();
        
        // First fetch the summary data (fast)
        fetch('/api/dashboard.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('No data available');
                }
                return response.json();
            })
            .then(summary => {
                // Hide the no data message
                document.getElementById('noDataMessage').style.display = 'none';
                
                // Render the summary charts that are immediately available
                if (summary.summary && summary.summary.funnel) {
                    renderFunnelChart(summary.summary.funnel);
                }
                
                if (summary.summary && summary.summary.conversion_rates) {
                    renderConversionChart(summary.summary.conversion_rates);
                }
                
                console.log('Available sections:', summary.sections_available);
                
                // Now fetch each section of data in parallel for better performance
                // Check if we have campaign_performance and channel_performance sections
                const availableSections = summary.sections_available || [];
                
                // Prepare API requests based on available sections
                const requests = [];
                const sectionMappings = {};
                
                if (availableSections.includes('campaign_performance')) {
                    requests.push(fetchSectionData('campaign_performance'));
                    sectionMappings['campaign_performance'] = 'campaign';
                } else if (availableSections.includes('campaign_type_performance')) {
                    // Fallback to campaign_type if campaign_performance is not available
                    requests.push(fetchSectionData('campaign_type_performance'));
                    sectionMappings['campaign_type_performance'] = 'campaign';
                }
                
                if (availableSections.includes('channel_performance')) {
                    requests.push(fetchSectionData('channel_performance'));
                    sectionMappings['channel_performance'] = 'channel';
                }
                
                if (availableSections.includes('cac')) {
                    requests.push(fetchSectionData('cac', {
                        page: state.cacPage, 
                        per_page: state.cacPerPage, 
                        sort_by: state.cacSortBy, 
                        sort_dir: state.cacSortDir
                    }));
                    sectionMappings['cac'] = 'cac';
                }
                
                if (requests.length === 0) {
                    console.error('No valid sections found in the data');
                    document.getElementById('noDataMessage').style.display = 'block';
                    hideLoading();
                    return;
                }
                
                Promise.all(requests)
                    .then(results => {
                        console.log('API responses:', results);
                        
                        // Map results to their respective chart rendering functions
                        results.forEach((result, index) => {
                            const sectionKey = Object.keys(sectionMappings)[index];
                            const chartType = sectionMappings[sectionKey];
                            
                            try {
                                if (chartType === 'campaign') {
                                    renderCampaignChart(result.data || result);
                                } else if (chartType === 'channel') {
                                    renderChannelChart(result.data || result);
                                } else if (chartType === 'cac') {
                                    renderCacTable(result.data || [], result.meta);
                                }
                            } catch (error) {
                                console.error(`Error rendering ${chartType} chart:`, error);
                            }
                        });
                        
                        // Hide all loading indicators
                        hideLoading();
                    })
                    .catch(err => {
                        console.error('Error fetching section data:', err);
                        // Show error message to user
                        document.getElementById('noDataMessage').querySelector('p').textContent = 
                            'Error loading chart data. Please check console for details or try refreshing the page.';
                        document.getElementById('noDataMessage').style.display = 'block';
                        hideLoading();
                    });
            })
            .catch(error => {
                console.error('Error fetching dashboard summary:', error);
                // Show the no data message
                document.getElementById('noDataMessage').style.display = 'block';
                hideLoading();
            });
    });
    
    // Helper function to fetch data sections
    function fetchSectionData(section, params = {}) {
        let url = `/api/dashboard/${section}.json`;
        
        // Append query params if we have any
        if (Object.keys(params).length > 0) {
            const queryString = new URLSearchParams(params).toString();
            url += `?${queryString}`;
        }
        
        return fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Failed to fetch ${section} data`);
                }
                return response.json();
            });
    }
    
    // Show loading indicators in each chart area
    function showLoading() {
        document.querySelectorAll('.card-body').forEach(cardBody => {
            // Only add spinner if it doesn't already have one
            if (!cardBody.querySelector('.spinner-container')) {
                const spinnerContainer = document.createElement('div');
                spinnerContainer.className = 'spinner-container d-flex justify-content-center align-items-center';
                spinnerContainer.style.position = 'absolute';
                spinnerContainer.style.top = '0';
                spinnerContainer.style.left = '0';
                spinnerContainer.style.width = '100%';
                spinnerContainer.style.height = '100%';
                spinnerContainer.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
                spinnerContainer.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
                
                // Make sure the card body has relative positioning for absolute spinner positioning
                if (getComputedStyle(cardBody).position === 'static') {
                    cardBody.style.position = 'relative';
                }
                
                cardBody.appendChild(spinnerContainer);
            }
        });
    }
    
    // Hide all loading indicators
    function hideLoading() {
        document.querySelectorAll('.spinner-container').forEach(spinner => {
            spinner.remove();
        });
    }

    // Funnel Chart
    function renderFunnelChart(funnelData) {
        const ctx = document.getElementById('funnelChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (funnelChartInstance) {
            funnelChartInstance.destroy();
        }
        
        // Check which data format we have (campaign or events)
        if (funnelData.impressions !== undefined) {
            // Campaign data format
            // Calculate a sensible y-axis maximum (20% above the highest value)
            const values = [funnelData.impressions, funnelData.clicks, funnelData.conversions];
            const maxValue = Math.max(...values);
            const yAxisMax = Math.ceil(maxValue * 1.2); // 20% headroom, rounded up
            
            funnelChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Impressions', 'Clicks', 'Conversions'],
                    datasets: [{
                        label: 'Count',
                        data: [funnelData.impressions, funnelData.clicks, funnelData.conversions],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(153, 102, 255, 0.7)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(153, 102, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: yAxisMax,
                            ticks: {
                                // Use shorter number format for large numbers
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(1) + 'K';
                                    }
                                    return value;
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Marketing Funnel'
                        }
                    }
                }
            });
        } else {
            // Original events data format
            // Calculate a sensible y-axis maximum (20% above the highest value)
            const values = [funnelData.page_view, funnelData.signup, funnelData.purchase];
            const maxValue = Math.max(...values);
            const yAxisMax = Math.ceil(maxValue * 1.2); // 20% headroom, rounded up
            
            funnelChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Page Views', 'Signups', 'Purchases'],
                    datasets: [{
                        label: 'User Count',
                        data: [funnelData.page_view, funnelData.signup, funnelData.purchase],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(153, 102, 255, 0.7)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(153, 102, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: yAxisMax,
                            ticks: {
                                // Use shorter number format for large numbers
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(1) + 'K';
                                    }
                                    return value;
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Marketing Funnel'
                        }
                    }
                }
            });
        }
    }

    // Conversion Rates Chart
    function renderConversionChart(conversionData) {
        const ctx = document.getElementById('conversionChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (conversionChartInstance) {
            conversionChartInstance.destroy();
        }
        
        // Check which data format we have (campaign or events)
        if (conversionData.click_through_rate !== undefined) {
            // Campaign data format
            conversionChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Click-Through Rate', 'Conversion Rate', 'ROI'],
                    datasets: [{
                        label: 'Rate (%)',
                        data: [conversionData.click_through_rate, conversionData.conversion_rate, conversionData.roi],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                            'rgba(255, 205, 86, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(255, 205, 86, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: Math.min(Math.ceil(Math.max(
                                conversionData.click_through_rate, 
                                conversionData.conversion_rate, 
                                conversionData.roi
                            ) * 1.2), 100), // Cap at 100% with headroom
                            title: {
                                display: true,
                                text: 'Value (%)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Key Performance Metrics'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw || 0;
                                    return `${context.label}: ${value.toFixed(2)}%`;
                                }
                            }
                        }
                    }
                }
            });
        } else {
            // Original events data format
            conversionChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Signup Rate', 'Purchase Rate', 'Overall Conversion'],
                    datasets: [{
                        label: 'Conversion Rate (%)',
                        data: [conversionData.signup_rate, conversionData.purchase_rate, conversionData.overall_conversion],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                            'rgba(255, 205, 86, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(255, 205, 86, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Percentage (%)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Conversion Rates'
                        }
                    }
                }
            });
        }
    }

    // Campaign Performance Chart
    function renderCampaignChart(campaignData) {
        const ctx = document.getElementById('campaignChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (campaignChartInstance) {
            campaignChartInstance.destroy();
        }
        
        // Limit to top 8 campaigns for visibility
        let displayData = campaignData;
        if (campaignData.length > 8) {
            displayData = campaignData.slice(0, 8);
        }
        
        const campaigns = displayData.map(c => c.campaign_name || c.campaign_type || 'Unknown');
        const rois = displayData.map(c => c.roi || 0);
        const conversionRates = displayData.map(c => c.conversion_rate || 0);
        
        // Calculate maximum value for y-axis scaling
        const maxROI = Math.max(...rois);
        const maxConversionRate = Math.max(...conversionRates);
        const yAxisMax = Math.ceil(Math.max(maxROI, maxConversionRate) * 1.2); // 20% headroom
        
        campaignChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: campaigns,
                datasets: [{
                    label: 'ROI (%)',
                    data: rois,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    yAxisID: 'y'
                }, {
                    label: 'Conversion Rate (%)',
                    data: conversionRates,
                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1,
                    yAxisID: 'y'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',  // Horizontal bar
                scales: {
                    y: {
                        stacked: false
                    },
                    x: {
                        beginAtZero: true,
                        max: Math.min(yAxisMax, 100),  // Cap at 100% with headroom
                        title: {
                            display: true,
                            text: 'Percentage (%)'
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Campaign Performance'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.raw || 0;
                                return `${label}: ${value.toFixed(2)}%`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Channel Performance Chart
    function renderChannelChart(channelData) {
        const ctx = document.getElementById('channelChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (channelChartInstance) {
            channelChartInstance.destroy();
        }
        
        // Check which data format we have (campaign or events)
        if (channelData.length > 0 && channelData[0].roi !== undefined) {
            // Campaign data format - show conversion rates by channel
            
            // Limit to top 6 channels for better visualization
            let displayData = channelData;
            if (channelData.length > 6) {
                displayData = channelData.slice(0, 6);
            }
            
            const channels = displayData.map(item => item.channel);
            const conversionRates = displayData.map(item => item.conversion_rate);
            const acquisitionCosts = displayData.map(item => item.acquisition_cost);
            
            channelChartInstance = new Chart(ctx, {
                type: 'bar', // Change to bar chart for better scaling
                data: {
                    labels: channels,
                    datasets: [{
                        label: 'Conversion Rate (%)',
                        data: conversionRates,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // Horizontal bar chart for better readability
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: Math.min(Math.ceil(Math.max(...conversionRates) * 1.2), 100), // Cap at 100% with headroom
                            title: {
                                display: true,
                                text: 'Conversion Rate (%)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Channel Performance by Conversion Rate'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.x || 0;
                                    return `Conversion: ${value.toFixed(2)}%`;
                                },
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    return `Acquisition Cost: $${acquisitionCosts[index].toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
        } else {
            // Original events data format
            // Limit to top 6 channels for better visualization
            let displayData = channelData;
            if (channelData.length > 6) {
                displayData = displayData.slice(0, 6);
            }
            
            const channels = displayData.map(item => item.channel);
            const purchaseRates = displayData.map(item => item.purchase_rate);
            
            channelChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: channels,
                    datasets: [{
                        label: 'Purchase Rate (%)',
                        data: purchaseRates,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // Horizontal bar chart for better readability
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: Math.min(Math.ceil(Math.max(...purchaseRates) * 1.2), 100), // Cap at 100% with headroom
                            title: {
                                display: true,
                                text: 'Purchase Rate (%)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Channel Performance by Purchase Rate'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.x || 0;
                                    return `Purchase rate: ${value.toFixed(2)}%`;
                                }
                            }
                        }
                    }
                }
            });
        }
    }

    // Customer Acquisition Cost Table
    function renderCacTable(cacData, paginationMeta) {
        const tableBody = document.getElementById('cacTable').querySelector('tbody');
        tableBody.innerHTML = '';
        
        if (cacData.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="4" class="text-center">No data available</td>`;
            tableBody.appendChild(row);
            
            // Hide pagination if no data
            document.getElementById('pagination').innerHTML = '';
            return;
        }
        
        // Render table rows
        cacData.forEach(item => {
            const row = document.createElement('tr');
            
            // Format the values appropriately
            const roi = parseFloat(item.roi || 0).toFixed(2);
            const conversionRate = parseFloat(item.conversion_rate || 0).toFixed(2);
            const acquisitionCost = parseFloat(item.acquisition_cost || 0).toFixed(2);
            
            row.innerHTML = `
                <td>${item.channel || 'Unknown'}</td>
                <td>${roi}%</td>
                <td>${conversionRate}%</td>
                <td>$${acquisitionCost}</td>
            `;
            
            tableBody.appendChild(row);
        });
        
        // Update UI controls to match current state
        if (paginationMeta) {
            document.getElementById('sortSelect').value = state.cacSortBy;
            document.getElementById('perPageSelect').value = state.cacPerPage;
            
            // Update sort direction icon
            if (state.cacSortDir === 'asc') {
                document.getElementById('sortDirectionBtn').innerHTML = '<i class="fas fa-sort-amount-up"></i>';
            } else {
                document.getElementById('sortDirectionBtn').innerHTML = '<i class="fas fa-sort-amount-down"></i>';
            }
            
            // Set up event listeners
            document.getElementById('perPageSelect').onchange = function(e) {
                state.cacPerPage = parseInt(e.target.value, 10);
                state.cacPage = 1;  // Reset to first page
                fetchAndRenderCacTable();
            };
            
            document.getElementById('sortSelect').onchange = function(e) {
                state.cacSortBy = e.target.value;
                fetchAndRenderCacTable();
            };
            
            document.getElementById('sortDirectionBtn').onclick = function() {
                if (state.cacSortDir === 'asc') {
                    state.cacSortDir = 'desc';
                    this.innerHTML = '<i class="fas fa-sort-amount-down"></i>';
                } else {
                    state.cacSortDir = 'asc';
                    this.innerHTML = '<i class="fas fa-sort-amount-up"></i>';
                }
                fetchAndRenderCacTable();
            };
            
            // Render pagination
            renderPagination(paginationMeta);
        }
    }
    
    // Fetch and render CAC table data with current pagination/sorting state
    function fetchAndRenderCacTable() {
        showLoading();
        
        fetchSectionData('cac', {
            page: state.cacPage,
            per_page: state.cacPerPage,
            sort_by: state.cacSortBy,
            sort_dir: state.cacSortDir
        })
        .then(result => {
            renderCacTable(result.data || [], result.meta);
            hideLoading();
        })
        .catch(error => {
            console.error('Error fetching CAC data:', error);
            hideLoading();
        });
    }
    
    // Pagination UI
    function renderPagination(meta) {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        
        if (!meta || !meta.total_pages || meta.total_pages <= 1) {
            return;  // No pagination needed
        }
        
        // Previous button
        const prevBtn = document.createElement('button');
        prevBtn.className = 'btn btn-sm btn-outline-primary';
        prevBtn.innerHTML = '&laquo; Previous';
        prevBtn.disabled = meta.page <= 1;
        prevBtn.onclick = function() {
            if (meta.page > 1) {
                state.cacPage = meta.page - 1;
                fetchAndRenderCacTable();
            }
        };
        
        // Page info
        const pageInfo = document.createElement('div');
        pageInfo.className = 'pagination-info';
        
        // Calculate range of items shown
        const startItem = ((meta.page - 1) * meta.per_page) + 1;
        const endItem = Math.min(startItem + meta.per_page - 1, meta.total_items);
        
        pageInfo.innerHTML = `
            <span>Showing ${startItem} to ${endItem} of ${meta.total_items} entries</span>
            <div class="btn-group ms-2">
                ${renderPageNumbers(meta)}
            </div>
        `;
        
        // Next button
        const nextBtn = document.createElement('button');
        nextBtn.className = 'btn btn-sm btn-outline-primary';
        nextBtn.innerHTML = 'Next &raquo;';
        nextBtn.disabled = meta.page >= meta.total_pages;
        nextBtn.onclick = function() {
            if (meta.page < meta.total_pages) {
                state.cacPage = meta.page + 1;
                fetchAndRenderCacTable();
            }
        };
        
        // Add elements to pagination container
        pagination.appendChild(prevBtn);
        pagination.appendChild(pageInfo);
        pagination.appendChild(nextBtn);
    }
    
    // Generate page number buttons
    function renderPageNumbers(meta) {
        if (!meta) return '';
        
        let pages = '';
        const currentPage = meta.page;
        const totalPages = meta.total_pages;
        
        // Reset page if it's somehow beyond the available range
        if (currentPage > totalPages) {
            state.cacPage = 1;
            setTimeout(fetchAndRenderCacTable, 0);
            return '';
        }
        
        // Always show first page
        pages += `<button class="btn btn-sm ${currentPage === 1 ? 'btn-primary' : 'btn-outline-secondary'}" 
                  onclick="state.cacPage = 1; fetchAndRenderCacTable();">1</button>`;
        
        // Show ellipsis after first page if needed
        if (currentPage > 3) {
            pages += `<button class="btn btn-sm btn-outline-secondary" disabled>...</button>`;
        }
        
        // Calculate range of page numbers to show
        let startPage = Math.max(2, currentPage - 1);
        let endPage = Math.min(totalPages - 1, currentPage + 1);
        
        // Adjust range if at edges
        if (currentPage <= 3) {
            endPage = Math.min(totalPages - 1, 4);
        }
        if (currentPage >= totalPages - 2) {
            startPage = Math.max(2, totalPages - 3);
        }
        
        // Generate page number buttons
        for (let i = startPage; i <= endPage; i++) {
            pages += `<button class="btn btn-sm ${currentPage === i ? 'btn-primary' : 'btn-outline-secondary'}" 
                     onclick="state.cacPage = ${i}; fetchAndRenderCacTable();">${i}</button>`;
        }
        
        // Show ellipsis before last page if needed
        if (currentPage < totalPages - 2) {
            pages += `<button class="btn btn-sm btn-outline-secondary" disabled>...</button>`;
        }
        
        // Always show last page if there is more than one page
        if (totalPages > 1) {
            pages += `<button class="btn btn-sm ${currentPage === totalPages ? 'btn-primary' : 'btn-outline-secondary'}" 
                     onclick="state.cacPage = ${totalPages}; fetchAndRenderCacTable();">${totalPages}</button>`;
        }
        
        return pages;
    }
</script>
{% endblock %}
