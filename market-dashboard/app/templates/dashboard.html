{% extends "base.html" %}

{% block title %}Dashboard - Marketing Insights{% endblock %}

{% block header %}Marketing Performance Dashboard{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="row">
        <!-- Funnel Overview Card -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Conversion Funnel</h5>
                </div>
                <div class="card-body chart-body">
                    <div class="chart-container">
                        <canvas id="funnelChart" class="chart-canvas" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conversion Rates Card -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Conversion Rates</h5>
                </div>
                <div class="card-body chart-body">
                    <div class="chart-container">
                        <canvas id="conversionChart" class="chart-canvas" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Campaign Performance Card -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Campaign Performance</h5>
                </div>
                <div class="card-body chart-body">
                    <div class="chart-container">
                        <canvas id="campaignChart" class="chart-canvas" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Channel Performance Card -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Channel Performance</h5>
                </div>
                <div class="card-body chart-body">
                    <div class="chart-container">
                        <canvas id="channelChart" class="chart-canvas" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Acquisition Cost Table -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Customer Acquisition Cost</h5>
                    <div class="d-flex">
                        <div class="me-2">
                            <label for="perPageSelect" class="me-1">Show:</label>
                            <select id="perPageSelect" class="form-select form-select-sm">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <div>
                            <label for="sortSelect" class="me-1">Sort by:</label>
                            <select id="sortSelect" class="form-select form-select-sm">
                                <option value="channel">Channel</option>
                                <option value="roi">ROI</option>
                                <option value="conversion_rate">Conversion Rate</option>
                                <option value="acquisition_cost">Acquisition Cost</option>
                            </select>
                        </div>
                        <button id="sortDirectionBtn" class="btn btn-sm btn-outline-secondary ms-2">
                            <i class="fas fa-sort-amount-up"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="cacTable" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Channel</th>
                                    <th>ROI (%)</th>
                                    <th>Conversion Rate (%)</th>
                                    <th>Acquisition Cost ($)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="pagination" class="d-flex justify-content-between align-items-center mt-3">
                        <!-- Pagination will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- No data message -->
    <div id="noDataMessage" class="text-center my-5" style="display: none;">
        <div class="alert alert-danger">
            <h4 class="alert-heading">No Data Available</h4>
            <p>There is no marketing data to display. Please upload a dataset.</p>
            <div class="mt-3">
                <strong>Troubleshooting:</strong>
                <ul class="text-start mt-2">
                    <li>Check if you've uploaded marketing data</li>
                    <li>Verify the API is returning the expected data (check browser console)</li>
                    <li>Make sure Chart.js and other dependencies are loaded</li>
                    <li>Try clearing your browser cache and refreshing</li>
                </ul>
            </div>
            {% if current_user.is_authenticated %}
                <a href="{{ url_for('main.upload') }}" class="btn btn-primary">Upload Data</a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Diagnostic script to check for errors -->
<script>
    // Add diagnostic console log
    console.log('Dashboard initialization starting...');
    
    // Function to check if scripts are loaded
    function checkScriptLoading() {
        console.log('Checking script loading status...');
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded!');
            document.getElementById('noDataMessage').style.display = 'block';
            document.getElementById('noDataMessage').querySelector('p').textContent = 
                'Error: Chart.js library failed to load. Please check your internet connection and try refreshing the page.';
        } else {
            console.log('Chart.js is loaded successfully.');
        }
        
        // Check our utility functions
        if (typeof resetCanvas === 'undefined') {
            console.error('chart-reset.js is not loaded!');
        } else {
            console.log('chart-reset.js loaded successfully.');
        }
        
        if (typeof getDefaultChartConfig === 'undefined') {
            console.error('chart-config.js is not loaded!');
        } else {
            console.log('chart-config.js loaded successfully.');
        }
        
        if (typeof ChartManager === 'undefined') {
            console.error('chart-manager.js is not loaded!');
        } else {
            console.log('ChartManager loaded successfully.');
        }
        
        if (typeof VisualizationConfig === 'undefined') {
            console.error('enhanced-visualizations.js is not loaded!');
        } else {
            console.log('enhanced-visualizations.js loaded successfully.');
        }
    }
    
    // Run diagnostic after all scripts should be loaded
    window.addEventListener('load', checkScriptLoading);
</script>

<!-- Chart.js and plugins -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<!-- Custom chart utilities -->
<script src="{{ url_for('static', filename='js/chart-reset.js') }}"></script>
<script src="{{ url_for('static', filename='js/chart-config.js') }}"></script>
<script src="{{ url_for('static', filename='js/chart-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/enhanced-visualizations.js') }}"></script>
<script src="{{ url_for('static', filename='js/data-validator.js') }}"></script>
<!-- Debugging tools -->
<script src="{{ url_for('static', filename='js/debug-api.js') }}"></script>
<script>
    // Global state to track pagination
    const state = {
        cacPage: 1,
        cacPerPage: 10,
        cacSortBy: 'roi',
        cacSortDir: 'desc'
    };
    
    // Chart instances to manage destruction/recreation
    let funnelChartInstance = null;
    let conversionChartInstance = null;
    let campaignChartInstance = null;
    let channelChartInstance = null;
    
    // Fetch dashboard data using the optimized endpoints
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded - initializing dashboard');
        
        // Clear any previously rendered charts
        if (window.Chart) {
            console.log('Destroying any existing chart instances');
            // Destroy all chart instances to prevent memory leaks
            Chart.helpers.each(Chart.instances, function(instance) {
                instance.destroy();
            });
        } else {
            console.error('Chart.js not available yet!');
        }
        
        // Show loading indicators
        showLoading();
        console.log('Loading indicators displayed');
        
        // First fetch the summary data (fast)
        console.log('Fetching dashboard summary from /api/dashboard.json');
        fetch('/api/dashboard.json')
            .then(response => {
                console.log('API Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`API returned status ${response.status}: No data available`);
                }
                return response.json();
            })
            .then(summary => {
                // Hide the no data message
                document.getElementById('noDataMessage').style.display = 'none';
                
                // Render the summary charts that are immediately available
                if (summary.summary && summary.summary.funnel) {
                    console.log('Processing funnel data');
                    // Validate funnel data
                    let funnelData = summary.summary.funnel;
                    if (!DataValidator.validateFunnelData(funnelData)) {
                        console.warn('Using sample funnel data instead');
                        funnelData = DataValidator.generateSampleFunnelData();
                    } else {
                        funnelData = DataValidator.sanitizeFunnelData(funnelData);
                    }
                    renderFunnelChart(funnelData);
                }
                
                if (summary.summary && summary.summary.conversion_rates) {
                    console.log('Processing conversion rates data');
                    // Validate conversion rates data
                    let conversionData = summary.summary.conversion_rates;
                    if (!DataValidator.validateConversionRatesData(conversionData)) {
                        console.warn('Using sample conversion rates data instead');
                        conversionData = DataValidator.generateSampleConversionRatesData();
                    } else {
                        conversionData = DataValidator.sanitizeConversionRatesData(conversionData);
                    }
                    renderConversionChart(conversionData);
                }
                
                console.log('Available sections:', summary.sections_available);
                
                // Now fetch each section of data in parallel for better performance
                // Check if we have campaign_performance and channel_performance sections
                const availableSections = summary.sections_available || [];
                
                // Prepare API requests based on available sections
                const requests = [];
                const sectionMappings = {};
                
                if (availableSections.includes('campaign_performance')) {
                    requests.push(fetchSectionData('campaign_performance'));
                    sectionMappings['campaign_performance'] = 'campaign';
                } else if (availableSections.includes('campaign_type_performance')) {
                    // Fallback to campaign_type if campaign_performance is not available
                    requests.push(fetchSectionData('campaign_type_performance'));
                    sectionMappings['campaign_type_performance'] = 'campaign';
                }
                
                if (availableSections.includes('channel_performance')) {
                    requests.push(fetchSectionData('channel_performance'));
                    sectionMappings['channel_performance'] = 'channel';
                }
                
                if (availableSections.includes('cac')) {
                    requests.push(fetchSectionData('cac', {
                        page: state.cacPage, 
                        per_page: state.cacPerPage, 
                        sort_by: state.cacSortBy, 
                        sort_dir: state.cacSortDir
                    }));
                    sectionMappings['cac'] = 'cac';
                }
                
                if (requests.length === 0) {
                    console.error('No valid sections found in the data');
                    document.getElementById('noDataMessage').style.display = 'block';
                    hideLoading();
                    return;
                }
                
                Promise.all(requests)
                    .then(results => {
                        console.log('API responses:', results);
                        
                        // Map results to their respective chart rendering functions
                        results.forEach((result, index) => {
                            const sectionKey = Object.keys(sectionMappings)[index];
                            const chartType = sectionMappings[sectionKey];
                            
                            try {
                                if (chartType === 'campaign') {
                                    console.log('Processing campaign data');
                                    let campaignData = result.data || result;
                                    if (!DataValidator.validateCampaignData(campaignData)) {
                                        console.warn('Using sample campaign data instead');
                                        campaignData = DataValidator.generateSampleCampaignData();
                                    } else {
                                        campaignData = DataValidator.sanitizeCampaignData(campaignData);
                                    }
                                    renderCampaignChart(campaignData);
                                } else if (chartType === 'channel') {
                                    console.log('Processing channel data');
                                    let channelData = result.data || result;
                                    if (!DataValidator.validateChannelData(channelData)) {
                                        console.warn('Using sample channel data instead');
                                        channelData = DataValidator.generateSampleChannelData();
                                    } else {
                                        channelData = DataValidator.sanitizeChannelData(channelData);
                                    }
                                    renderChannelChart(channelData);
                                } else if (chartType === 'cac') {
                                    console.log('Processing CAC table data');
                                    let cacData = result.data || [];
                                    if (cacData.length === 0 || 
                                        (cacData.length > 0 && 
                                        (cacData[0].conversion_rate === 0 || 
                                         cacData[0].acquisition_cost === 0))) {
                                        console.warn('Using sample channel data for CAC table');
                                        cacData = DataValidator.generateSampleChannelData();
                                    }
                                    renderCacTable(cacData, result.meta);
                                }
                            } catch (error) {
                                console.error(`Error rendering ${chartType} chart:`, error);
                            }
                        });
                        
                        // Hide all loading indicators
                        hideLoading();
                    })
                    .catch(err => {
                        console.error('Error fetching section data:', err);
                        // Show error message to user
                        document.getElementById('noDataMessage').querySelector('p').textContent = 
                            'Error loading chart data. Please check console for details or try refreshing the page.';
                        document.getElementById('noDataMessage').style.display = 'block';
                        hideLoading();
                    });
            })
            .catch(error => {
                console.error('Error fetching dashboard summary:', error);
                // Show the no data message with the specific error
                document.getElementById('noDataMessage').style.display = 'block';
                document.getElementById('noDataMessage').querySelector('p').textContent = 
                    `Error loading data: ${error.message}. Check that the API endpoint exists and the server is running.`;
                hideLoading();
                
                // Try diagnosing the API issue
                fetch('/api')
                    .then(response => {
                        console.log('API root endpoint status:', response.status);
                        if (!response.ok) {
                            console.error('API root endpoint not available');
                        }
                    })
                    .catch(err => {
                        console.error('Cannot reach API at all:', err);
                    });
            });
    });
    
    // Helper function to fetch data sections
    function fetchSectionData(section, params = {}) {
        let url = `/api/dashboard/${section}.json`;
        
        // Append query params if we have any
        if (Object.keys(params).length > 0) {
            const queryString = new URLSearchParams(params).toString();
            url += `?${queryString}`;
        }
        
        return fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Failed to fetch ${section} data`);
                }
                return response.json();
            });
    }
    
    // Show loading indicators in each chart area
    function showLoading() {
        document.querySelectorAll('.card-body').forEach(cardBody => {
            // Only add spinner if it doesn't already have one
            if (!cardBody.querySelector('.spinner-container')) {
                const spinnerContainer = document.createElement('div');
                spinnerContainer.className = 'spinner-container d-flex justify-content-center align-items-center';
                spinnerContainer.style.position = 'absolute';
                spinnerContainer.style.top = '0';
                spinnerContainer.style.left = '0';
                spinnerContainer.style.width = '100%';
                spinnerContainer.style.height = '100%';
                spinnerContainer.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
                spinnerContainer.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
                
                // Make sure the card body has relative positioning for absolute spinner positioning
                if (getComputedStyle(cardBody).position === 'static') {
                    cardBody.style.position = 'relative';
                }
                
                cardBody.appendChild(spinnerContainer);
            }
        });
    }
    
    // Hide all loading indicators
    function hideLoading() {
        document.querySelectorAll('.spinner-container').forEach(spinner => {
            spinner.remove();
        });
    }

    // Funnel Chart - Enhanced visualization
    function renderFunnelChart(funnelData) {
        // Check which data format we have (campaign or events)
        if (funnelData.impressions !== undefined) {
            // Campaign data format - use enhanced funnel
            return renderEnhancedFunnel('funnelChart', funnelData);
        } else {
            // Original events data format
            const values = [funnelData.page_view, funnelData.signup, funnelData.purchase];
            
            // Create an adapted format for the enhanced funnel renderer
            const adaptedData = {
                impressions: funnelData.page_view || 0,
                clicks: funnelData.signup || 0,
                conversions: funnelData.purchase || 0
            };
            
            return renderEnhancedFunnel('funnelChart', adaptedData);
        }
    }

    // Conversion Rates Chart - Enhanced visualization
    function renderConversionChart(conversionData) {
        // Check which data format we have (campaign or events)
        if (conversionData.click_through_rate !== undefined) {
            // Campaign data format
            const values = [
                conversionData.click_through_rate, 
                conversionData.conversion_rate, 
                conversionData.roi
            ];
            
            // Use chart defaults from VisualizationConfig
            conversionChartInstance = ChartManager.createChart('conversionChart', 'bar', {
                labels: ['Click-Through Rate', 'Conversion Rate', 'ROI'],
                datasets: [{
                    label: 'Rate (%)',
                    data: values,
                    backgroundColor: [
                        VisualizationConfig.colorSchemes.primary[2],
                        VisualizationConfig.colorSchemes.primary[1],
                        VisualizationConfig.colorSchemes.primary[3]
                    ],
                    borderColor: [
                        VisualizationConfig.colorSchemes.borders[2],
                        VisualizationConfig.colorSchemes.borders[1],
                        VisualizationConfig.colorSchemes.borders[3]
                    ],
                    borderWidth: 1
                }]
            }, VisualizationConfig.chartDefaults.conversionMetrics.options);
        } else {
            // Original events data format
            const values = [
                conversionData.signup_rate, 
                conversionData.purchase_rate, 
                conversionData.overall_conversion
            ];
            
            // Use chart defaults from VisualizationConfig
            conversionChartInstance = ChartManager.createChart('conversionChart', 'bar', {
                labels: ['Signup Rate', 'Purchase Rate', 'Overall Conversion'],
                datasets: [{
                    label: 'Conversion Rate (%)',
                    data: values,
                    backgroundColor: [
                        VisualizationConfig.colorSchemes.primary[2],
                        VisualizationConfig.colorSchemes.primary[1],
                        VisualizationConfig.colorSchemes.primary[3]
                    ],
                    borderColor: [
                        VisualizationConfig.colorSchemes.borders[2],
                        VisualizationConfig.colorSchemes.borders[1],
                        VisualizationConfig.colorSchemes.borders[3]
                    ],
                    borderWidth: 1
                }]
            }, {
                ...VisualizationConfig.chartDefaults.conversionMetrics.options,
                plugins: {
                    ...VisualizationConfig.chartDefaults.conversionMetrics.options.plugins,
                    title: {
                        display: true,
                        text: 'Conversion Rates'
                    }
                }
            });
        }
    }

    // Campaign Performance Chart - Enhanced visualization
    function renderCampaignChart(campaignData) {
        // Use the enhanced campaign visualization
        return renderEnhancedCampaignComparison('campaignChart', campaignData);
    }

    // Channel Performance Chart - Enhanced visualization
    function renderChannelChart(channelData) {
        // Check which data format we have (campaign or events)
        if (channelData.length > 0 && channelData[0].roi !== undefined) {
            // Campaign data format - use enhanced channel visualization
            return renderEnhancedChannelPerformance('channelChart', channelData);
        } else {
            // Original events data format - adapt to our enhanced visualization
            // Create a compatible format for the enhanced channel renderer
            const adaptedData = channelData.map(item => ({
                channel: item.channel || 'Unknown',
                conversion_rate: item.purchase_rate || 0,
                acquisition_cost: item.cost_per_purchase || 1  // Default to 1 if not available
            }));
            
            return renderEnhancedChannelPerformance('channelChart', adaptedData);
        }
    }

    // Customer Acquisition Cost Table
    function renderCacTable(cacData, paginationMeta) {
        const tableBody = document.getElementById('cacTable').querySelector('tbody');
        tableBody.innerHTML = '';
        
        if (cacData.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="4" class="text-center">No data available</td>`;
            tableBody.appendChild(row);
            
            // Hide pagination if no data
            document.getElementById('pagination').innerHTML = '';
            return;
        }
        
        // Render table rows
        cacData.forEach(item => {
            const row = document.createElement('tr');
            
            // Format the values appropriately
            const roi = parseFloat(item.roi || 0).toFixed(2);
            const conversionRate = parseFloat(item.conversion_rate || 0).toFixed(2);
            const acquisitionCost = parseFloat(item.acquisition_cost || 0).toFixed(2);
            
            row.innerHTML = `
                <td>${item.channel || 'Unknown'}</td>
                <td>${roi}%</td>
                <td>${conversionRate}%</td>
                <td>$${acquisitionCost}</td>
            `;
            
            tableBody.appendChild(row);
        });
        
        // Update UI controls to match current state
        if (paginationMeta) {
            document.getElementById('sortSelect').value = state.cacSortBy;
            document.getElementById('perPageSelect').value = state.cacPerPage;
            
            // Update sort direction icon
            if (state.cacSortDir === 'asc') {
                document.getElementById('sortDirectionBtn').innerHTML = '<i class="fas fa-sort-amount-up"></i>';
            } else {
                document.getElementById('sortDirectionBtn').innerHTML = '<i class="fas fa-sort-amount-down"></i>';
            }
            
            // Set up event listeners
            document.getElementById('perPageSelect').onchange = function(e) {
                state.cacPerPage = parseInt(e.target.value, 10);
                state.cacPage = 1;  // Reset to first page
                fetchAndRenderCacTable();
            };
            
            document.getElementById('sortSelect').onchange = function(e) {
                state.cacSortBy = e.target.value;
                fetchAndRenderCacTable();
            };
            
            document.getElementById('sortDirectionBtn').onclick = function() {
                if (state.cacSortDir === 'asc') {
                    state.cacSortDir = 'desc';
                    this.innerHTML = '<i class="fas fa-sort-amount-down"></i>';
                } else {
                    state.cacSortDir = 'asc';
                    this.innerHTML = '<i class="fas fa-sort-amount-up"></i>';
                }
                fetchAndRenderCacTable();
            };
            
            // Render pagination
            renderPagination(paginationMeta);
        }
    }
    
    // Fetch and render CAC table data with current pagination/sorting state
    function fetchAndRenderCacTable() {
        showLoading();
        
        fetchSectionData('cac', {
            page: state.cacPage,
            per_page: state.cacPerPage,
            sort_by: state.cacSortBy,
            sort_dir: state.cacSortDir
        })
        .then(result => {
            renderCacTable(result.data || [], result.meta);
            hideLoading();
        })
        .catch(error => {
            console.error('Error fetching CAC data:', error);
            hideLoading();
        });
    }
    
    // Pagination UI
    function renderPagination(meta) {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        
        if (!meta || !meta.total_pages || meta.total_pages <= 1) {
            return;  // No pagination needed
        }
        
        // Previous button
        const prevBtn = document.createElement('button');
        prevBtn.className = 'btn btn-sm btn-outline-primary';
        prevBtn.innerHTML = '&laquo; Previous';
        prevBtn.disabled = meta.page <= 1;
        prevBtn.onclick = function() {
            if (meta.page > 1) {
                state.cacPage = meta.page - 1;
                fetchAndRenderCacTable();
            }
        };
        
        // Page info
        const pageInfo = document.createElement('div');
        pageInfo.className = 'pagination-info';
        
        // Calculate range of items shown
        const startItem = ((meta.page - 1) * meta.per_page) + 1;
        const endItem = Math.min(startItem + meta.per_page - 1, meta.total_items);
        
        pageInfo.innerHTML = `
            <span>Showing ${startItem} to ${endItem} of ${meta.total_items} entries</span>
            <div class="btn-group ms-2">
                ${renderPageNumbers(meta)}
            </div>
        `;
        
        // Next button
        const nextBtn = document.createElement('button');
        nextBtn.className = 'btn btn-sm btn-outline-primary';
        nextBtn.innerHTML = 'Next &raquo;';
        nextBtn.disabled = meta.page >= meta.total_pages;
        nextBtn.onclick = function() {
            if (meta.page < meta.total_pages) {
                state.cacPage = meta.page + 1;
                fetchAndRenderCacTable();
            }
        };
        
        // Add elements to pagination container
        pagination.appendChild(prevBtn);
        pagination.appendChild(pageInfo);
        pagination.appendChild(nextBtn);
    }
    
    // Generate page number buttons
    function renderPageNumbers(meta) {
        if (!meta) return '';
        
        let pages = '';
        const currentPage = meta.page;
        const totalPages = meta.total_pages;
        
        // Reset page if it's somehow beyond the available range
        if (currentPage > totalPages) {
            state.cacPage = 1;
            setTimeout(fetchAndRenderCacTable, 0);
            return '';
        }
        
        // Always show first page
        pages += `<button class="btn btn-sm ${currentPage === 1 ? 'btn-primary' : 'btn-outline-secondary'}" 
                  onclick="state.cacPage = 1; fetchAndRenderCacTable();">1</button>`;
        
        // Show ellipsis after first page if needed
        if (currentPage > 3) {
            pages += `<button class="btn btn-sm btn-outline-secondary" disabled>...</button>`;
        }
        
        // Calculate range of page numbers to show
        let startPage = Math.max(2, currentPage - 1);
        let endPage = Math.min(totalPages - 1, currentPage + 1);
        
        // Adjust range if at edges
        if (currentPage <= 3) {
            endPage = Math.min(totalPages - 1, 4);
        }
        if (currentPage >= totalPages - 2) {
            startPage = Math.max(2, totalPages - 3);
        }
        
        // Generate page number buttons
        for (let i = startPage; i <= endPage; i++) {
            pages += `<button class="btn btn-sm ${currentPage === i ? 'btn-primary' : 'btn-outline-secondary'}" 
                     onclick="state.cacPage = ${i}; fetchAndRenderCacTable();">${i}</button>`;
        }
        
        // Show ellipsis before last page if needed
        if (currentPage < totalPages - 2) {
            pages += `<button class="btn btn-sm btn-outline-secondary" disabled>...</button>`;
        }
        
        // Always show last page if there is more than one page
        if (totalPages > 1) {
            pages += `<button class="btn btn-sm ${currentPage === totalPages ? 'btn-primary' : 'btn-outline-secondary'}" 
                     onclick="state.cacPage = ${totalPages}; fetchAndRenderCacTable();">${totalPages}</button>`;
        }
        
        return pages;
    }
</script>
{% endblock %}
