<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Manager Tests</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mocha@10.2.0/mocha.css">
    <script src="https://cdn.jsdelivr.net/npm/mocha@10.2.0/mocha.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chai@4.3.7/chai.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sinon@15.0.1/pkg/sinon.js"></script>
    
    <!-- Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Files to test -->
    <script src="../app/static/js/chart-reset.js"></script>
    <script src="../app/static/js/chart-config.js"></script>
    <script src="../app/static/js/chart-manager.js"></script>
    
    <style>
        /* Test container styles */
        #test-container {
            display: none;
        }
        .test-chart-container {
            width: 300px;
            height: 200px;
        }
    </style>
</head>
<body>
    <div id="mocha"></div>
    
    <!-- Test container for chart rendering -->
    <div id="test-container">
        <div class="chart-container test-chart-container">
            <canvas id="test-chart" class="chart-canvas"></canvas>
        </div>
    </div>
    
    <script>
        mocha.setup('bdd');
        const expect = chai.expect;
        
        // Helper to create a clean test environment
        function setupTestEnvironment() {
            const container = document.getElementById('test-container');
            container.style.display = 'block';
            
            // Reset any existing chart
            if (ChartManager.instances['test-chart']) {
                ChartManager.destroyChart('test-chart');
            }
            
            // Make sure we have a fresh canvas
            const existingCanvas = document.getElementById('test-chart');
            if (existingCanvas) {
                existingCanvas.remove();
            }
            
            const chartContainer = document.querySelector('.test-chart-container');
            const canvas = document.createElement('canvas');
            canvas.id = 'test-chart';
            canvas.className = 'chart-canvas';
            chartContainer.appendChild(canvas);
            
            return canvas;
        }
        
        // Tests for chart-reset.js
        describe('Chart Reset Functions', function() {
            it('should reset a canvas correctly', function() {
                const canvas = setupTestEnvironment();
                
                // First get original canvas dimensions
                const originalWidth = canvas.width;
                const originalHeight = canvas.height;
                
                // Draw something on the canvas to modify its state
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = 'red';
                ctx.fillRect(0, 0, 50, 50);
                
                // Now reset the canvas
                const newCtx = resetCanvas('test-chart');
                
                // Check that we got a context back
                expect(newCtx).to.be.an.instanceof(CanvasRenderingContext2D);
                
                // Check that canvas exists
                const newCanvas = document.getElementById('test-chart');
                expect(newCanvas).to.exist;
                
                // Check that the canvas has the right class
                expect(newCanvas.className).to.include('chart-canvas');
                
                // Check that canvas has style attributes
                expect(newCanvas.style.maxHeight).to.equal('100%');
                expect(newCanvas.style.maxWidth).to.equal('100%');
            });
        });
        
        // Tests for chart-manager.js
        describe('ChartManager', function() {
            beforeEach(function() {
                // Setup fresh environment
                setupTestEnvironment();
                
                // Make sure ChartManager is clean
                ChartManager.clearAll();
            });
            
            it('should create a new chart instance', function() {
                const chart = ChartManager.createChart('test-chart', 'bar', {
                    labels: ['A', 'B', 'C'],
                    datasets: [{
                        label: 'Test Data',
                        data: [10, 20, 30],
                        backgroundColor: 'rgba(75, 192, 192, 0.7)'
                    }]
                });
                
                // Verify chart was created
                expect(chart).to.be.an('object');
                expect(chart.id).to.be.a('number');
                expect(chart.ctx).to.exist;
                
                // Verify chart is stored in ChartManager
                expect(ChartManager.instances['test-chart']).to.exist;
                expect(ChartManager.instances['test-chart']).to.equal(chart);
            });
            
            it('should destroy a chart instance', function() {
                // First create a chart
                ChartManager.createChart('test-chart', 'bar', {
                    labels: ['A', 'B', 'C'],
                    datasets: [{
                        label: 'Test Data',
                        data: [10, 20, 30],
                        backgroundColor: 'rgba(75, 192, 192, 0.7)'
                    }]
                });
                
                // Verify chart exists
                expect(ChartManager.instances['test-chart']).to.exist;
                
                // Now destroy it
                const result = ChartManager.destroyChart('test-chart');
                
                // Verify destroy worked
                expect(result).to.be.true;
                expect(ChartManager.instances['test-chart']).to.be.undefined;
            });
            
            it('should return false when trying to destroy non-existent chart', function() {
                const result = ChartManager.destroyChart('non-existent-chart');
                expect(result).to.be.false;
            });
            
            it('should clear all chart instances', function() {
                // Create multiple charts
                ChartManager.createChart('test-chart', 'bar', {
                    labels: ['A', 'B', 'C'],
                    datasets: [{
                        label: 'Test Data',
                        data: [10, 20, 30]
                    }]
                });
                
                // Create a second test chart
                const secondCanvas = document.createElement('canvas');
                secondCanvas.id = 'test-chart-2';
                document.body.appendChild(secondCanvas);
                
                ChartManager.createChart('test-chart-2', 'line', {
                    labels: ['X', 'Y', 'Z'],
                    datasets: [{
                        label: 'Test Series',
                        data: [5, 15, 25]
                    }]
                });
                
                // Verify both charts exist
                expect(Object.keys(ChartManager.instances)).to.have.lengthOf(2);
                
                // Clear all charts
                ChartManager.clearAll();
                
                // Verify no charts remain
                expect(Object.keys(ChartManager.instances)).to.have.lengthOf(0);
                
                // Clean up
                secondCanvas.remove();
            });
            
            it('should replace an existing chart when creating with same ID', function() {
                // Create initial chart
                const chart1 = ChartManager.createChart('test-chart', 'bar', {
                    labels: ['A', 'B', 'C'],
                    datasets: [{
                        label: 'Test Data',
                        data: [10, 20, 30]
                    }]
                });
                
                // Create second chart with same ID
                const chart2 = ChartManager.createChart('test-chart', 'line', {
                    labels: ['X', 'Y', 'Z'],
                    datasets: [{
                        label: 'New Data',
                        data: [100, 200, 300]
                    }]
                });
                
                // Verify the second chart replaced the first
                expect(chart2).to.not.equal(chart1);
                expect(ChartManager.instances['test-chart']).to.equal(chart2);
                expect(ChartManager.instances['test-chart']).to.not.equal(chart1);
            });
        });
        
        // Tests for utility functions
        describe('Chart Utility Functions', function() {
            it('should calculate Y-axis maximum correctly', function() {
                const values = [10, 20, 50];
                const result = calculateYAxisMax(values);
                
                // Should be 20% above max value (50), rounded up
                expect(result).to.equal(60);
            });
            
            it('should format large numbers correctly', function() {
                expect(formatLargeNumber(1000)).to.equal('1.0K');
                expect(formatLargeNumber(1500)).to.equal('1.5K');
                expect(formatLargeNumber(1000000)).to.equal('1.0M');
                expect(formatLargeNumber(2500000)).to.equal('2.5M');
                expect(formatLargeNumber(500)).to.equal(500);
            });
        });
        
        // Run the tests
        mocha.run();
    </script>
</body>
</html>
